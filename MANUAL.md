# Local LLM Chat — ユーザーマニュアル

Local LLM Chat は、ローカルで動作する LLM サーバー（LM Studio、Ollama など）と連携する Web ベースのチャットインターフェースです。

## 目次

1. [セットアップ](#セットアップ)
2. [基本的な使い方](#基本的な使い方)
3. [詳細設定](#詳細設定)
4. [Vision モデル（画像入力）](#vision-モデル画像入力)
5. [メッセージ管理](#メッセージ管理)
6. [キーボードショートカット](#キーボードショートカット)
7. [トラブルシューティング](#トラブルシューティング)

---

## セットアップ

### 必要な環境

- **LM Studio**：ローカルにインストールされ、サーバーが起動している必要があります
- **Webブラウザ**：Chrome、Firefox、Safari、Edgeなどのモダンブラウザ

### 初回起動手順

1. **LM Studio を起動**
   - LM Studio アプリケーションを開きます
   - 使用したいモデルをロードします
   - サーバーを起動します（通常は `http://localhost:1234` で起動）

2. **HTMLファイルを開く**
   - `local_llm_chat.html` をブラウザで開きます
   - ファイルをダブルクリックするか、ブラウザにドラッグ&ドロップします

3. **接続設定の確認**（必要な場合のみ）
   - ⚙️ Settings を開いて **Base URL** が LM Studio のアドレスと一致していることを確認
     - **Base URL**：LM Studio APIサーバーのアドレス
     - デフォルト：`http://localhost:1234/v1`（通常は変更不要）

4. **モデルの選択**
   - 起動時に自動的にモデル一覧が取得されます
   - プルダウンメニューから使用したいモデルを選択
   - 🔄 Refresh ボタンでモデル一覧を再取得できます

---

## 基本的な使い方

### メッセージの送信

1. 画面下部のテキストエリアにメッセージを入力
2. 以下のいずれかの方法で送信：
   - **Enter キー**を押す
   - **送信ボタン**をクリック
3. 改行したい場合は **Shift + Enter**

### 入力欄の自動拡張

- 長いメッセージを入力すると、テキストエリアが自動的に拡張されます
- 最大高さ：240px（それ以上はスクロール）

### 会話の表示

- **青色の吹き出し**：あなたのメッセージ（右寄せ）
- **白色の吹き出し**：AIの応答（左寄せ）
- **灰色の小さい通知**：システムメッセージ

### 応答の停止

- AIが応答生成中に **⏹ Stop** ボタンをクリックすると、生成を中断できます

---

## 詳細設定

### 設定パネルを開く

画面上部の **⚙️ Settings** ボタンをクリックすると、詳細設定パネルが表示されます。

### 🌙 Dark Mode（ダークモード）

- **説明**：目に優しいダークテーマに切り替えます
- **使い方**：
  1. ⚙️ Settings を開く
  2. 🌙 Dark Mode のチェックボックスをON/OFF
- **自動保存**：設定は自動的に保存され、次回起動時も維持されます

### 🔗 Base URL

- **デフォルト**：`http://localhost:1234/v1`
- **説明**：LLM サーバーの API エンドポイントです
- **変更するケース**：
  - 別のポートで LM Studio を起動している場合
  - Ollama（`http://localhost:11434/v1`）を使用する場合
  - リモートサーバーに接続する場合

### 🔑 API Key

- **デフォルト**：`lmstudio`
- **説明**：API認証キーです。ローカルで LM Studio を使用する場合は変更不要です
- **使用するケース**：
  - OpenAI API などのクラウドサービスを使用する場合
  - リモートサーバーで認証が必要な場合

### Temperature（温度）

- **範囲**：0.0 〜 2.0
- **デフォルト**：0.7
- **説明**：
  - **低い値（0.0 - 0.5）**：より一貫性のある、予測可能な応答
  - **中程度（0.5 - 1.0）**：バランスの取れた応答（推奨）
  - **高い値（1.0 - 2.0）**：創造的で多様な応答

### Max Tokens（最大トークン数）

- **範囲**：1 〜 8192
- **デフォルト**：2048
- **説明**：
  - AIが生成する応答の最大長を制限します
  - 長い応答が必要な場合は大きい値に設定
  - トークン ≒ 単語数（日本語の場合、1文字 ≒ 1-2トークン）

### 応答スタイル

- **選択肢**：
  - **簡潔（要点のみ）**：要点のみを短く答えます。冗長な説明を避け、核心的な情報のみを提供
  - **標準（バランス型）**：バランスの取れた応答（デフォルト）
  - **詳細（詳しい説明付き）**：背景情報、理由、具体例などを含めて丁寧に説明
  - **専門的（技術的詳細重視）**：学術的な正確性を保ち、専門用語を適切に使用し、エビデンスや根拠を明示
- **デフォルト**：標準（バランス型）
- **説明**：
  - AIの応答の詳しさを設定できます
  - 選択したスタイルは自動的にシステムプロンプトに統合されます
  - 設定は自動保存され、次回起動時も維持されます
- **使い方**：
  1. ⚙️ Settings を開く
  2. 「応答スタイル」のドロップダウンから好みのスタイルを選択
  3. 設定は自動的に保存されます

### 👤 ユーザープロフィール

ユーザーの専門レベルや興味に合わせた応答を受けるための設定です。

#### 専門レベル

- **選択肢**：
  - **指定なし**：特に指定しない（デフォルト）
  - **初心者**：専門用語を避け、基礎から丁寧に説明
  - **中級者**：基本的な知識を前提に、適度な専門用語を使用
  - **上級者**：専門的な内容を深く掘り下げて説明
  - **専門家**：高度な専門知識を前提とし、最新の研究や詳細な技術的議論を含む
- **説明**：
  - AIはあなたの専門レベルに応じた説明をします
  - 初心者向けには簡単な言葉で、専門家向けには高度な内容で応答します

#### 職業/専門分野

- **入力例**：放射線科医、医学生、研究者、エンジニア、看護師など
- **説明**：
  - あなたの職業や専門分野を入力します
  - AIはこの情報を考慮して、関連性の高い応答を提供します

#### 興味・関心

- **入力例**：CT画像診断、機械学習、病理診断、MRI解析など
- **説明**：
  - 特に興味のある分野やトピックを入力します
  - AIはあなたの関心に沿った内容を重視して応答します

#### 設定方法

1. ⚙️ Settings を開く
2. 「👤 ユーザープロフィール」セクションで各項目を設定
3. 設定は自動的に保存され、次回起動時も維持されます

#### 設定例

**例1：医学生**
- 専門レベル：初心者
- 職業/専門分野：医学生
- 興味・関心：CT画像診断

→ AIは初心者向けに基礎から説明し、医学教育の文脈でCT画像診断に関する内容を提供します。

**例2：放射線科専門医**
- 専門レベル：専門家
- 職業/専門分野：放射線科医
- 興味・関心：AI診断支援、機械学習

→ AIは高度な専門知識を前提とし、最新のAI診断技術や機械学習の応用について詳しく議論します。

### System Prompt（システムプロンプト）

- **デフォルト**：
  ```
  You are a helpful Japanese-speaking assistant for a radiologist.
  ```
- **説明**：
  - AIの役割や振る舞いを定義します
  - 専門分野や話し方、回答スタイルを指定できます
- **例**：
  ```
  You are a friendly programming tutor. Explain concepts clearly with examples.
  ```

### 設定の保存

- すべての設定は自動的にブラウザに保存されます
- 次回起動時も設定が引き継がれます

---

## Vision モデル（画像入力）

Vision対応モデル（LLaVA、Bakllavaなど）を使用している場合、画像を入力できます。

### 画像の送信方法

#### 方法1：ファイル選択

1. **📷 Image** ボタンをクリック
2. 画像ファイルを選択
3. プレビューが表示されます
4. テキストを入力（任意）
5. **送信** ボタンで送信

#### 方法2：ペースト

1. スクリーンショットを撮る
   - **Mac**: `Cmd + Shift + 4`
   - **Windows**: `Win + Shift + S`
2. ページ内で `Ctrl + V`（Mac: `Cmd + V`）でペースト
3. 画像が自動的にプレビュー表示されます
4. テキストを入力（任意）
5. **送信** ボタンで送信

#### 方法3：ドラッグ＆ドロップ（推奨）

1. 画像ファイルをウィンドウ内にドラッグ
   - ドラッグ中は画面が薄くなります
2. ウィンドウ内でドロップ
3. 画像が自動的にプレビュー表示されます
4. テキストを入力（任意）
5. **送信** ボタンで送信

### 画像の仕様

- **対応形式**：PNG、JPEG、GIF、WebP など、すべての画像形式
- **最大サイズ**：20MB
- **送信数**：一度に1枚まで

### 画像の削除

- プレビュー右上の **×** ボタンをクリック
- 送信後は自動的にプレビューがクリアされます

### 注意事項

- Vision対応モデルを選択してください
- テキストなしで画像のみの送信も可能です
- 画像データは会話履歴に保存されます

---

## メッセージ管理

### メッセージアクション

各メッセージにマウスカーソルを合わせると、アクションボタンが表示されます。

#### 📋 Copy（コピー）

- メッセージの内容をクリップボードにコピーします
- すべてのメッセージで利用可能

#### 🗑 Delete（削除）

- 個別のメッセージを削除します
- 削除されたメッセージは会話履歴からも消えます

#### 🔄 Regenerate（再生成）

- **AIの応答のみ**で表示されます
- 同じ質問に対して異なる応答を生成したい場合に使用
- 元の応答を削除して、新しい応答を自動的に生成します

### 会話履歴の管理

#### 💾 Export（エクスポート）

- 会話履歴をJSON形式でダウンロードします
- ファイル名：`chat_history_YYYY-MM-DDTHH-MM-SS.json`
- バックアップや分析に利用できます
- 画像データも含めて保存されます

#### 🗑 Clear（クリア）

- すべての会話履歴を削除します
- 確認ダイアログが表示されます
- **注意**：この操作は取り消せません

---

## キーボードショートカット

効率的な操作のためのショートカット一覧です。

| ショートカット | 機能 | 備考 |
|--------------|------|------|
| `Enter` | メッセージを送信 | IME変換中は無効 |
| `Shift + Enter` | 改行 | メッセージ内で改行 |
| `Ctrl + V`（Mac: `Cmd + V`） | 画像をペースト | クリップボードから画像を貼り付け |
| `Ctrl + K`（Mac: `Cmd + K`） | 会話履歴をクリア | 確認ダイアログ表示 |
| `Esc` | 設定パネルを閉じる | パネルが開いている時のみ |

---

## トラブルシューティング

### モデル一覧が取得できない

**症状**：
- プルダウンメニューに "Loading..." が表示されたまま
- "⚠️ モデル一覧を取得できませんでした" というメッセージ

**解決方法**：
1. LM Studio が起動しているか確認
2. LM Studio でモデルがロードされているか確認
3. Base URL が正しいか確認（デフォルト：`http://localhost:1234/v1`）
4. LM Studio のサーバーが起動しているか確認
5. 🔄 Refresh ボタンをクリックして再試行

### メッセージ送信時にエラーが出る

**症状**：
- "⚠️ 選択モデルが /v1/models に見つかりません" というメッセージ

**解決方法**：
1. モデルを選択し直す
2. 🔄 Refresh ボタンでモデル一覧を更新
3. LM Studio で別のモデルをロード
4. ページをリロード

### 応答が途中で止まる

**症状**：
- AIの応答が完了せずに停止

**解決方法**：
1. Max Tokens の設定を増やす（⚙️ Settings から）
2. LM Studio のコンソールでエラーが出ていないか確認
3. 🔄 Regenerate ボタンで再生成を試す

### 画像が送信できない

**症状**：
- 画像を選択/ペーストしても反応がない
- 送信後にエラーが表示される

**解決方法**：
1. Vision対応モデルを選択しているか確認（LLaVA、Bakllavaなど）
2. 画像サイズが20MB以下か確認
3. 対応形式（PNG、JPEG、GIF、WebP）か確認
4. ブラウザのコンソールでエラーを確認

### 会話履歴が消えた

**症状**：
- ページをリロードしたら会話が消えている

**原因**：
- ブラウザの履歴やキャッシュを削除した
- プライベートモード（シークレットモード）で使用している

**対策**：
- 定期的に 💾 Export で履歴をバックアップ
- 通常モードのブラウザで使用

### 日本語入力時に誤送信される

**症状**：
- 日本語変換中に Enter を押すと送信されてしまう

**確認事項**：
- 最新版のコードでは IME 変換中の誤送信を防止する処理が実装されています
- ブラウザをリロードして確認してください

---

## データの保存場所

このアプリケーションは以下のデータをブラウザの **localStorage** に保存します：

- **会話履歴**：`chatHistory_auto_models`
  - メッセージテキスト
  - 画像データ（base64形式）
- **設定情報**：`chatSettings_auto_models`
  - Base URL
  - API Key
  - 選択中のモデル
  - Temperature
  - Max Tokens
  - System Prompt
  - 応答スタイル
  - ユーザープロフィール（専門レベル、職業/専門分野、興味・関心）
  - Dark Mode設定

**注意**：
- ブラウザの履歴やキャッシュを削除すると、これらのデータも消えます
- 重要な会話は 💾 Export でバックアップを取ることをお勧めします

---

## 技術仕様

### 対応 API

- OpenAI 互換 API（LM Studio が提供）
- エンドポイント：
  - `/v1/models`：モデル一覧取得
  - `/v1/chat/completions`：チャット応答生成（ストリーミング）
- Vision API対応：
  - 画像入力（base64形式）
  - マルチモーダルメッセージ

### ブラウザ要件

- JavaScript 有効
- localStorage サポート
- Fetch API サポート
- AbortController サポート（応答停止機能に必要）
- Clipboard API サポート（画像ペースト機能に必要）

### 外部依存

- **marked.js**（CDN）：Markdown レンダリング
  - URL: `https://cdn.jsdelivr.net/npm/marked/marked.min.js`

---

## よくある質問（FAQ）

### Q1: インターネット接続は必要ですか？

**A**: 基本的に不要です。ただし、初回起動時に marked.js（Markdown レンダリングライブラリ）をCDNから読み込むため、インターネット接続が必要です。一度読み込まれた後は、オフラインでも動作します。

### Q2: 複数のモデルを同時に使えますか？

**A**: いいえ。一度に使用できるモデルは1つだけです。モデルを切り替えたい場合は、プルダウンメニューから別のモデルを選択してください。

### Q3: 会話履歴に上限はありますか？

**A**: アプリケーション自体に制限はありませんが、API リクエスト時には直近12メッセージのみが送信されます。これは、モデルのコンテキスト長を超えないようにするためです。

### Q4: エクスポートした JSON ファイルを再インポートできますか？

**A**: 現在のバージョンではインポート機能は実装されていません。JSON ファイルは記録用として保存してください。

### Q5: 画像を送信できますか？

**A**: はい、Vision対応モデル（LLaVA、Bakllavaなど）を使用している場合、画像を送信できます。📷 Imageボタンからファイルを選択するか、`Ctrl+V`（Mac: `Cmd+V`）でスクリーンショットを直接ペーストできます。

### Q6: Base URL と API Key は何ですか？

**A**:
- **Base URL**：LM Studio APIサーバーのアドレスです。デフォルトは `http://localhost:1234/v1` で、通常は変更不要です。
- **API Key**：API認証キーです。デフォルトは `lmstudio` で、LM Studioの標準設定では変更不要です。

どちらも ⚙️ Settings パネル内にあります。

### Q7: ダークモードはありますか？

**A**: はい。⚙️ Settings を開いて 🌙 Dark Mode にチェックを入れることで、目に優しいダークテーマに切り替えられます。設定は自動保存されます。

### Q8: 応答スタイルとは何ですか？

**A**: 応答スタイルは、AIの応答の詳しさを設定する機能です。4つのスタイルから選択できます：
- **簡潔（要点のみ）**：短く核心的な情報のみ
- **標準（バランス型）**：バランスの取れた応答（デフォルト）
- **詳細（詳しい説明付き）**：背景情報や具体例を含む丁寧な説明
- **専門的（技術的詳細重視）**：学術的な正確性と専門用語を重視

⚙️ Settings の「応答スタイル」から選択でき、設定は自動保存されます。

### Q9: ユーザープロフィールとは何ですか？

**A**: ユーザープロフィールは、あなたの専門レベルや興味に合わせた応答を受けるための機能です。以下の項目を設定できます：
- **専門レベル**：初心者、中級者、上級者、専門家から選択
- **職業/専門分野**：あなたの職業や専門分野（例：放射線科医、医学生）
- **興味・関心**：特に興味のある分野（例：CT画像診断、機械学習）

これらの情報を設定すると、AIはあなたのレベルに合わせた説明をし、関心のある分野に焦点を当てた応答を提供します。⚙️ Settings の「👤 ユーザープロフィール」から設定でき、自動保存されます。

---

## バージョン情報

- **バージョン**：1.1.0
- **最終更新**：2025-11-29
- **主な機能**：
  - LM Studio との自動モデル同期
  - ストリーミング応答
  - Vision対応（画像入力・ペースト・ドラッグ＆ドロップ）
  - ファイル添付機能（テキスト、コード等）
  - カスタマイズ可能な設定（Temperature、Max Tokens、System Prompt、応答スタイル）
  - 応答スタイルのカスタマイズ（簡潔/標準/詳細/専門的）
  - ユーザープロフィール設定（専門レベル、職業/専門分野、興味・関心）
  - ダークモード
  - メッセージ管理（コピー、削除、再生成）
  - キーボードショートカット
  - レスポンシブデザイン
  - 会話履歴の永続化
  - 埋め込みモデルの自動フィルタリング

---

## サポート

問題が発生した場合や機能要望がある場合は、開発者にお問い合わせください。

**お問い合わせ前の確認事項**：
1. LM Studio が正しく起動しているか
2. モデルがロードされているか
3. ブラウザのコンソールにエラーメッセージが表示されていないか
4. このマニュアルのトラブルシューティングセクションを確認したか

---

**Happy Chatting! 🎉**
