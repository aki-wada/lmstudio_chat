<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8" />
<title>Local LLM Chat v1.7.1</title>
<meta name="viewport" content="width=device-width, initial-scale=1" />
<link rel="stylesheet" href="./assets/app.css?v=1.7.1" />
<script src="./assets/marked.min.js"></script>
<script src="./assets/pdf.min.js"></script>
<script>
  if (typeof pdfjsLib !== 'undefined') {
    pdfjsLib.GlobalWorkerOptions.workerSrc = './assets/pdf.worker.min.js';
  }
</script>
</head>
<body>
<header>
  <div class="row" style="justify-content:center;text-align:center;width:100%">
    <strong style="font-size:1.3em">Local LLM Chat</strong>
  </div>
  <div class="row">
    <span>モデル:</span>
    <select id="modelSelect" title="クリックでモデル一覧を更新">
      <!-- クリック時に自動更新 -->
    </select>
    <button id="compareBtn" title="2つのモデルの回答を比較" style="border:2px solid #6f42c1;background:#fff;color:#6f42c1">📊 比較</button>
    <span id="compareRow" style="display:none">
      <span style="margin-left:16px">比較:</span>
      <select id="compareModelSelect" title="比較対象のモデルを選択">
        <!-- 比較モード時に表示 -->
      </select>
    </span>
  </div>
  <div class="row" style="justify-content:flex-end;gap:6px">
    <!-- 会話操作 -->
    <button id="newTopicBtn" title="会話コンテキストをリセット" style="background:#17a2b8">🆕 新しい話題</button>
    <button id="clearBtn" title="すべての会話を消去">🗑️</button>
    <span style="border-left:1px solid rgba(255,255,255,0.3);height:24px;margin:0 4px"></span>
    <!-- データ管理 -->
    <button id="exportBtn" title="会話履歴を保存">💾</button>
    <button id="importBtn" title="会話履歴を読み込み">📥</button>
    <input type="file" id="importInput" accept=".json" style="display:none" />
    <span style="border-left:1px solid rgba(255,255,255,0.3);height:24px;margin:0 4px"></span>
    <!-- システム -->
    <button id="helpBtn" title="ヘルプを表示" style="border:2px solid #fd7e14;background:#fff;color:#fd7e14">❓</button>
    <button id="settingsBtn" title="設定">⚙️</button>
  </div>
</header>

<div id="settingsPanel" class="settings-panel">
  <div class="settings-row">
    <label>
      <input type="checkbox" id="darkModeToggle" />
      🌙 Dark Mode
    </label>
  </div>
  <div class="settings-row">
    <label>
      <input type="checkbox" id="showLogprobsToggle" />
      📊 信頼度・代替候補を表示 (Open Responses API)
    </label>
    <span class="note">※ LM Studio v0.3.39以降が必要</span>
  </div>
  <div class="settings-row">
    <label>🔗 Base URL:</label>
    <input type="text" id="baseUrl" value="http://localhost:1234/v1" style="width:220px" />
    <span class="note">※ デフォルト: http://localhost:1234/v1</span>
  </div>
  <div class="settings-row">
    <label>🔑 API Key:</label>
    <input type="text" id="apiKey" value="lmstudio" style="width:150px" />
    <span class="note">※ 通常は変更不要</span>
  </div>
  <div class="settings-row">
    <label>Temperature (0-2):</label>
    <input type="range" id="temperature" min="0" max="2" step="0.1" value="0.7" />
    <span id="tempValue">0.7</span>
    <span class="note">※ 低いと安定、高いと創造的</span>
  </div>
  <div class="settings-row">
    <label>Max Tokens:</label>
    <input type="number" id="maxTokens" min="1" max="8192" value="2048" />
  </div>
  <div class="settings-row">
    <label>送信キー:</label>
    <select id="sendKey">
      <option value="enter">Enter で送信</option>
      <option value="ctrl-enter">Ctrl+Enter で送信</option>
    </select>
    <span class="note">※ Enterのみで送信 or Ctrl+Enter で送信</span>
  </div>
  <div class="settings-row">
    <label>応答スタイル:</label>
    <select id="responseStyle">
      <option value="concise">簡潔（要点のみ）</option>
      <option value="standard" selected>標準（バランス型）</option>
      <option value="detailed">詳細（詳しい説明付き）</option>
      <option value="professional">専門的（技術的詳細重視）</option>
    </select>
    <span class="note">※ AIの応答の詳しさを設定</span>
  </div>
  <div class="settings-row">
    <label>👤 ユーザープロフィール</label>
  </div>
  <div class="settings-row">
    <label>専門レベル:</label>
    <select id="userLevel">
      <option value="">指定なし</option>
      <option value="beginner">初心者</option>
      <option value="intermediate">中級者</option>
      <option value="advanced">上級者</option>
      <option value="expert">専門家</option>
    </select>
  </div>
  <div class="settings-row">
    <label>職業/専門分野:</label>
    <input type="text" id="userProfession" placeholder="例: 放射線科医、学生、研究者" style="width:200px" />
  </div>
  <div class="settings-row">
    <label>興味・関心:</label>
    <input type="text" id="userInterests" placeholder="例: CT画像診断、機械学習" style="width:200px" />
  </div>
  <div class="settings-row">
    <label>System Prompt:</label>
    <textarea id="systemPrompt">あなたは放射線画像診断、技術、研究のエキスパートアシスタントです。日本語で簡潔でバランスの取れたアドバイスを提供してください。フォーマルとカジュアルのバランスを保ち、専門用語は英語（日本語）の形式で表記してください。</textarea>
  </div>
  <div class="settings-row" style="margin-top:16px;border-top:1px solid #ddd;padding-top:16px">
    <label>📋 プリセット編集</label>
  </div>
  <div class="settings-row">
    <label>編集するプリセット:</label>
    <select id="presetEditSelect"></select>
  </div>
  <div class="settings-row">
    <label>新規プリセット名:</label>
    <input type="text" id="newPresetName" placeholder="例: 画像所見整理" style="width:200px" />
    <button id="addPresetBtn" style="background:#17a2b8">＋ 追加</button>
  </div>
  <div class="settings-row">
    <textarea id="presetEditText" style="width:100%;max-width:600px;min-height:120px"></textarea>
  </div>
  <div class="settings-row">
    <button id="savePresetBtn" style="background:#28a745">💾 保存</button>
    <button id="resetPresetBtn" style="background:#dc3545">🔄 デフォルトに戻す</button>
    <button id="deletePresetBtn" style="background:#c82333">🗑 削除</button>
    <button id="resetAllPresetsBtn" style="background:#6c757d">全てリセット</button>
  </div>
  <div class="settings-row" style="margin-top:16px;border-top:1px solid #ddd;padding-top:16px">
    <label>🔧 データ管理</label>
  </div>
  <div class="settings-row">
    <button id="resetSettingsBtn" style="background:#ffc107;color:#000">🔄 設定をデフォルトに戻す</button>
    <button id="clearAllDataBtn" style="background:#dc3545">🗑 すべての保存データを消す</button>
  </div>
  <div class="settings-row" style="margin-top:16px">
    <button id="closeSettingsBtn" style="background:#6c757d">← 戻る</button>
  </div>
</div>

<div id="chat"></div>

<div id="presetPanel" class="preset-panel">
  <div class="preset-header">
    <strong>📋 プリセットプロンプト</strong>
    <button id="closePresetBtn" class="preset-close">×</button>
  </div>
  <div class="preset-list" id="presetList"></div>
</div>

<div id="input-area">
  <div style="display:flex;flex-direction:column;gap:8px">
    <label for="imageInput" style="padding:0 12px;height:36px;line-height:36px;font-size:0.95em;border:none;border-radius:8px;background:#28a745;color:#fff;cursor:pointer;text-align:center">
      📷 Image
    </label>
    <input type="file" id="imageInput" accept="image/*" multiple style="display:none" />
    <label for="fileInput" style="padding:0 12px;height:36px;line-height:36px;font-size:0.95em;border:none;border-radius:8px;background:#6c757d;color:#fff;cursor:pointer;text-align:center">
      📎 File
    </label>
    <input type="file" id="fileInput" accept=".txt,.md,.json,.csv,.xml,.html,.css,.js,.ts,.py,.java,.c,.cpp,.h,.hpp,.sh,.yaml,.yml,.log,.pdf" multiple style="display:none" />
    <button id="deepDiveBtn" style="padding:0 12px;height:36px;font-size:0.95em;border:2px solid #6f42c1;border-radius:8px;background:#fff;color:#6f42c1;cursor:pointer;text-align:center;transition:all 0.2s">
      🔍 深掘り
    </button>
  </div>
  <div style="display:flex;flex-direction:column;flex:1;gap:8px;min-width:0">
    <div id="attachmentList" style="display:none;padding:8px;background:#f8f9fa;border-radius:8px;border:1px solid #ccc;font-size:0.9em;max-height:120px;overflow-y:auto;overflow-x:hidden">
      <!-- 添付ファイル一覧がここに表示される -->
    </div>
    <textarea id="prompt"
              placeholder="メッセージを入力…（送信キーは設定で変更可能）"
              autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false"></textarea>
  </div>
  <div style="display:flex;flex-direction:column;gap:8px">
    <button id="send">🚀 Send</button>
    <button id="stopBtn" disabled>⏹ Stop</button>
    <button id="presetBtn" style="padding:0 12px;height:36px;font-size:0.95em;border:none;border-radius:8px;background:#17a2b8;color:#fff;cursor:pointer;text-align:center">
      📋 Preset
    </button>
  </div>
</div>

<div id="version-badge" style="position:fixed;bottom:8px;right:12px;font-size:0.75em;color:#999;pointer-events:none;z-index:1">v1.7.1</div>

<script src="./js/app.js?v=1.7.1"></script>
</body>
</html>
