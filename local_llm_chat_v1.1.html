<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8" />
<title>Local LLM Chat</title>
<style>
  body{font-family:system-ui,sans-serif;background:#f1f3f5;margin:0;display:flex;flex-direction:column;height:100vh;}
  header{background:#007bff;color:#fff;padding:10px 20px;font-size:1.05em;display:flex;justify-content:space-between;align-items:center;gap:12px;flex-wrap:wrap}
  #chat{flex:1;overflow-y:auto;padding:20px;display:flex;flex-direction:column}
  .message{margin:10px 0;max-width:80%;padding:10px 14px;border-radius:10px;line-height:1.55;position:relative}
  .user{background:#007bff;color:#fff;align-self:flex-end}
  .assistant{background:#fff;border:1px solid #ddd;color:#222;align-self:flex-start}
  .system{background:#eee;color:#333;align-self:center;font-size:.9em;padding:6px 10px;border-radius:8px}
  #input-area{display:flex;padding:10px;background:#fff;border-top:1px solid #ccc;gap:10px}
  #prompt{flex:1;font-size:1em;padding:10px;border:1px solid #ccc;border-radius:8px;resize:none;height:56px;max-height:240px;overflow-y:auto}
  button{padding:0 12px;height:36px;font-size:0.95em;border:none;border-radius:8px;background:#007bff;color:#fff;cursor:pointer}
  button:hover{background:#0056b3}
  button:disabled{background:#aaa;cursor:not-allowed}
  input[type="text"]{padding:6px 8px;border-radius:6px;border:1px solid #ccc}
  select{padding:6px 8px;border-radius:6px;border:1px solid #ccc;font-size:.95em}
  pre,code{background:#f8f9fa;border-radius:5px;padding:5px}
  pre{overflow-x:auto}
  .row{display:flex;align-items:center;gap:10px;flex-wrap:wrap}
  .row.no-wrap{flex-wrap:nowrap;justify-content:space-between}
  .row.no-wrap .btn-group{display:flex;gap:8px;flex-wrap:nowrap;flex-shrink:0}
  .note{font-size:.9em;opacity:.9}
  .settings-panel{background:#f8f9fa;border-bottom:1px solid #ddd;padding:12px 20px;display:none}
  .settings-panel.open{display:block}
  .settings-row{display:flex;gap:20px;flex-wrap:wrap;align-items:center;margin-bottom:10px}
  .settings-row label{font-size:.9em;min-width:100px}
  .settings-row input[type="range"]{width:150px}
  .settings-row input[type="number"]{width:80px}
  .settings-row textarea{width:100%;max-width:600px;min-height:60px}
  .msg-actions{display:none;gap:6px;margin-top:8px}
  .message:hover .msg-actions{display:flex}
  .msg-btn{padding:4px 8px;font-size:.8em;height:auto;background:#e9ecef;color:#333}
  .msg-btn:hover{background:#dee2e6}
  #imagePreview{display:none;margin:10px 0;position:relative}
  #imagePreview img{max-width:200px;max-height:200px;border-radius:8px;border:1px solid #ccc}
  #imagePreview .remove-img{position:absolute;top:-8px;right:-8px;background:#dc3545;color:#fff;border:none;border-radius:50%;width:24px;height:24px;cursor:pointer;font-size:.8em;line-height:1}
  #imagePreview .remove-img:hover{background:#c82333}
  .image-in-message{max-width:300px;max-height:300px;border-radius:8px;margin:8px 0;border:1px solid #ddd}
  @media (max-width:768px){
    header{font-size:.95em;padding:8px 12px}
    #prompt{height:48px}
    .message{max-width:90%}
  }
  /* === ãƒ€ãƒ¼ã‚¯ãƒ¢ãƒ¼ãƒ‰ === */
  body.dark-mode{background:#1a1a1a;color:#e0e0e0}
  body.dark-mode header{background:#2d2d2d}
  body.dark-mode #chat{background:#1a1a1a}
  body.dark-mode .user{background:#0056b3;color:#fff}
  body.dark-mode .assistant{background:#2d2d2d;border:1px solid #444;color:#e0e0e0}
  body.dark-mode .system{background:#333;color:#bbb}
  body.dark-mode #input-area{background:#2d2d2d;border-top:1px solid #444}
  body.dark-mode #prompt{background:#1a1a1a;border:1px solid #444;color:#e0e0e0}
  body.dark-mode button{background:#0056b3}
  body.dark-mode button:hover{background:#003d82}
  body.dark-mode button:disabled{background:#555}
  body.dark-mode input[type="text"],body.dark-mode select{background:#1a1a1a;border:1px solid #444;color:#e0e0e0}
  body.dark-mode .settings-panel{background:#2d2d2d;border-bottom:1px solid #444}
  body.dark-mode .settings-row textarea{background:#1a1a1a;border:1px solid #444;color:#e0e0e0}
  body.dark-mode .msg-btn{background:#444;color:#e0e0e0}
  body.dark-mode .msg-btn:hover{background:#555}
  body.dark-mode pre,body.dark-mode code{background:#2d2d2d;color:#e0e0e0}
  body.dark-mode .image-in-message{border:1px solid #444}
  body.dark-mode #imagePreview img{border:1px solid #444}
  body.dark-mode #filePreview{background:#2d2d2d;border:1px solid #444;color:#e0e0e0}
</style>
<script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
</head>
<body>
<header>
  <div class="row">
    <strong>ğŸ’¬ Local LLM Chat</strong>
    <span>ãƒ¢ãƒ‡ãƒ«:</span>
    <select id="modelSelect" title="ãƒ­ãƒ¼ãƒ‰ã•ã‚Œã¦ã„ã‚‹ãƒ¢ãƒ‡ãƒ«IDã‚’é¸æŠï¼ˆè‡ªå‹•åŒæœŸï¼‰">
      <!-- èµ·å‹•æ™‚ã« /v1/models ã‹ã‚‰è‡ªå‹•ç”Ÿæˆ -->
    </select>
    <button id="refreshBtn">ğŸ”„ Refresh</button>
  </div>
  <div class="row">
    <button id="clearBtn">ğŸ—‘ Clear</button>
    <button id="exportBtn">ğŸ’¾ Export</button>
    <button id="settingsBtn">âš™ï¸ Settings</button>
  </div>
</header>

<div id="settingsPanel" class="settings-panel">
  <div class="settings-row">
    <label>
      <input type="checkbox" id="darkModeToggle" />
      ğŸŒ™ Dark Mode
    </label>
  </div>
  <div class="settings-row">
    <label>ğŸ”— Base URL:</label>
    <input type="text" id="baseUrl" value="http://localhost:1234/v1" style="width:220px" />
    <span class="note">â€» ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆ: http://localhost:1234/v1</span>
  </div>
  <div class="settings-row">
    <label>ğŸ”‘ API Key:</label>
    <input type="text" id="apiKey" value="lmstudio" style="width:150px" />
    <span class="note">â€» é€šå¸¸ã¯å¤‰æ›´ä¸è¦</span>
  </div>
  <div class="settings-row">
    <label>Temperature (0-2):</label>
    <input type="range" id="temperature" min="0" max="2" step="0.1" value="0.7" />
    <span id="tempValue">0.7</span>
    <span class="note">â€» ä½ã„ã¨å®‰å®šã€é«˜ã„ã¨å‰µé€ çš„</span>
  </div>
  <div class="settings-row">
    <label>Max Tokens:</label>
    <input type="number" id="maxTokens" min="1" max="8192" value="2048" />
  </div>
  <div class="settings-row">
    <label>å¿œç­”ã‚¹ã‚¿ã‚¤ãƒ«:</label>
    <select id="responseStyle">
      <option value="concise">ç°¡æ½”ï¼ˆè¦ç‚¹ã®ã¿ï¼‰</option>
      <option value="standard" selected>æ¨™æº–ï¼ˆãƒãƒ©ãƒ³ã‚¹å‹ï¼‰</option>
      <option value="detailed">è©³ç´°ï¼ˆè©³ã—ã„èª¬æ˜ä»˜ãï¼‰</option>
      <option value="professional">å°‚é–€çš„ï¼ˆæŠ€è¡“çš„è©³ç´°é‡è¦–ï¼‰</option>
    </select>
    <span class="note">â€» AIã®å¿œç­”ã®è©³ã—ã•ã‚’è¨­å®š</span>
  </div>
  <div class="settings-row">
    <label>ğŸ‘¤ ãƒ¦ãƒ¼ã‚¶ãƒ¼ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«</label>
  </div>
  <div class="settings-row">
    <label>å°‚é–€ãƒ¬ãƒ™ãƒ«:</label>
    <select id="userLevel">
      <option value="">æŒ‡å®šãªã—</option>
      <option value="beginner">åˆå¿ƒè€…</option>
      <option value="intermediate">ä¸­ç´šè€…</option>
      <option value="advanced">ä¸Šç´šè€…</option>
      <option value="expert">å°‚é–€å®¶</option>
    </select>
  </div>
  <div class="settings-row">
    <label>è·æ¥­/å°‚é–€åˆ†é‡:</label>
    <input type="text" id="userProfession" placeholder="ä¾‹: æ”¾å°„ç·šç§‘åŒ»ã€å­¦ç”Ÿã€ç ”ç©¶è€…" style="width:200px" />
  </div>
  <div class="settings-row">
    <label>èˆˆå‘³ãƒ»é–¢å¿ƒ:</label>
    <input type="text" id="userInterests" placeholder="ä¾‹: CTç”»åƒè¨ºæ–­ã€æ©Ÿæ¢°å­¦ç¿’" style="width:200px" />
  </div>
  <div class="settings-row">
    <label>System Prompt:</label>
    <textarea id="systemPrompt">You are a helpful Japanese-speaking assistant for a radiologist.</textarea>
  </div>
  <div class="settings-row" style="margin-top:16px">
    <button id="closeSettingsBtn" style="background:#6c757d">â† æˆ»ã‚‹</button>
  </div>
</div>

<div id="chat"></div>

<div id="input-area">
  <div style="display:flex;flex-direction:column;gap:8px">
    <label for="imageInput" style="padding:0 12px;height:36px;line-height:36px;font-size:0.95em;border:none;border-radius:8px;background:#28a745;color:#fff;cursor:pointer;text-align:center">
      ğŸ“· Image
    </label>
    <input type="file" id="imageInput" accept="image/*" style="display:none" />
    <label for="fileInput" style="padding:0 12px;height:36px;line-height:36px;font-size:0.95em;border:none;border-radius:8px;background:#6c757d;color:#fff;cursor:pointer;text-align:center">
      ğŸ“ File
    </label>
    <input type="file" id="fileInput" accept=".txt,.md,.json,.csv,.xml,.html,.css,.js,.ts,.py,.java,.c,.cpp,.h,.hpp,.sh,.yaml,.yml,.log" style="display:none" />
  </div>
  <div style="display:flex;flex-direction:column;flex:1;gap:8px">
    <div id="imagePreview" style="display:none">
      <img id="previewImg" src="" alt="Preview" style="display:block" />
      <button class="remove-img" id="removeImage">Ã—</button>
    </div>
    <div id="filePreview" style="display:none;padding:8px;background:#f8f9fa;border-radius:8px;border:1px solid #ccc;font-size:0.9em">
      <span id="fileName"></span>
      <button class="remove-img" id="removeFile" style="position:relative;top:0;right:0;margin-left:8px">Ã—</button>
    </div>
    <textarea id="prompt"
              placeholder="ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’å…¥åŠ›â€¦ï¼ˆé€ä¿¡: Enter / æ”¹è¡Œ: Shift+Enterï¼‰"
              autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false"></textarea>
  </div>
  <div style="display:flex;flex-direction:column;gap:8px">
    <button id="send">é€ä¿¡</button>
    <button id="stopBtn" disabled>â¹ Stop</button>
  </div>
</div>

<script>
/* === åŸºæœ¬ã‚­ãƒ¼ === */
const STORAGE_KEY  = "chatHistory_auto_models";
const SETTINGS_KEY = "chatSettings_auto_models";

/* === è¦ç´  === */
const chatDiv      = document.getElementById("chat");
const baseUrlEl    = document.getElementById("baseUrl");
const apiKeyEl     = document.getElementById("apiKey");
const modelSel     = document.getElementById("modelSelect");
const promptEl     = document.getElementById("prompt");
const sendBtn      = document.getElementById("send");
const stopBtn      = document.getElementById("stopBtn");
const refreshBtn   = document.getElementById("refreshBtn");
const settingsBtn  = document.getElementById("settingsBtn");
const settingsPanel= document.getElementById("settingsPanel");
const temperatureEl= document.getElementById("temperature");
const tempValueEl  = document.getElementById("tempValue");
const maxTokensEl  = document.getElementById("maxTokens");
const systemPromptEl=document.getElementById("systemPrompt");
const imageInputEl = document.getElementById("imageInput");
const imagePreviewEl=document.getElementById("imagePreview");
const previewImgEl = document.getElementById("previewImg");
const removeImageBtn=document.getElementById("removeImage");
const fileInputEl  = document.getElementById("fileInput");
const filePreviewEl= document.getElementById("filePreview");
const fileNameEl   = document.getElementById("fileName");
const removeFileBtn= document.getElementById("removeFile");
const darkModeToggle= document.getElementById("darkModeToggle");
const responseStyleEl=document.getElementById("responseStyle");
const userLevelEl    = document.getElementById("userLevel");
const userProfessionEl=document.getElementById("userProfession");
const userInterestsEl= document.getElementById("userInterests");

let controller = null;             // AbortController for Stop
let availableModels = new Set();   // /v1/models ã®æ­£ç¢ºãªIDä¸€è¦§
let currentImageData = null;       // é¸æŠä¸­ã®ç”»åƒãƒ‡ãƒ¼ã‚¿ï¼ˆbase64ï¼‰
let currentFileData = null;        // é¸æŠä¸­ã®ãƒ•ã‚¡ã‚¤ãƒ«ãƒ‡ãƒ¼ã‚¿
let currentFileName = null;        // é¸æŠä¸­ã®ãƒ•ã‚¡ã‚¤ãƒ«å

/* === è¨­å®šãƒ­ãƒ¼ãƒ‰/ä¿å­˜ === */
let settings = JSON.parse(localStorage.getItem(SETTINGS_KEY) || "{}");
if (settings.baseUrl) baseUrlEl.value = settings.baseUrl;
if (settings.apiKey)  apiKeyEl.value  = settings.apiKey;
if (settings.temperature !== undefined) {
  temperatureEl.value = settings.temperature;
  tempValueEl.textContent = settings.temperature;
}
if (settings.maxTokens) maxTokensEl.value = settings.maxTokens;
if (settings.systemPrompt) systemPromptEl.value = settings.systemPrompt;
if (settings.responseStyle) responseStyleEl.value = settings.responseStyle;
if (settings.userLevel) userLevelEl.value = settings.userLevel;
if (settings.userProfession) userProfessionEl.value = settings.userProfession;
if (settings.userInterests) userInterestsEl.value = settings.userInterests;

// ãƒ€ãƒ¼ã‚¯ãƒ¢ãƒ¼ãƒ‰è¨­å®šã®å¾©å…ƒ
if (settings.darkMode) {
  document.body.classList.add("dark-mode");
  darkModeToggle.checked = true;
}

function saveSettings(){
  settings = {
    baseUrl: baseUrlEl.value.trim(),
    apiKey : apiKeyEl.value.trim(),
    model  : modelSel.value,
    temperature: parseFloat(temperatureEl.value),
    maxTokens: parseInt(maxTokensEl.value),
    systemPrompt: systemPromptEl.value,
    responseStyle: responseStyleEl.value,
    userLevel: userLevelEl.value,
    userProfession: userProfessionEl.value.trim(),
    userInterests: userInterestsEl.value.trim(),
    darkMode: document.body.classList.contains("dark-mode")
  };
  localStorage.setItem(SETTINGS_KEY, JSON.stringify(settings));
}
baseUrlEl.onchange = apiKeyEl.onchange = saveSettings;
temperatureEl.oninput = () => {
  tempValueEl.textContent = temperatureEl.value;
  saveSettings();
};
maxTokensEl.onchange = systemPromptEl.onchange = responseStyleEl.onchange = saveSettings;
userLevelEl.onchange = userProfessionEl.onchange = userInterestsEl.onchange = saveSettings;

/* === å±¥æ­´ãƒ­ãƒ¼ãƒ‰ === */
let messages = JSON.parse(localStorage.getItem(STORAGE_KEY) || "[]");
messages.forEach(m => appendMessage(m.role, m.content, false, m.imageData));

function appendMessage(role, content, save=true, imageData=null){
  const div = document.createElement("div");
  div.classList.add("message", role);

  // ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ãƒ‡ãƒ¼ã‚¿ã‚’ä¿å­˜ï¼ˆRegenerateç”¨ï¼‰
  div.dataset.content = content;
  if (imageData) div.dataset.imageData = imageData;

  // ç”»åƒãŒã‚ã‚‹å ´åˆã¯ç”»åƒã‚’è¡¨ç¤º
  if (imageData && role === "user") {
    const img = document.createElement("img");
    img.src = imageData;
    img.classList.add("image-in-message");
    div.appendChild(img);
  }

  const textDiv = document.createElement("div");
  textDiv.classList.add("message-content");
  textDiv.innerHTML = (role === "assistant") ? marked.parse(content) : content;

  // ãƒ†ã‚­ã‚¹ãƒˆã‚’è¿½åŠ 
  div.appendChild(textDiv);

  // ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚¢ã‚¯ã‚·ãƒ§ãƒ³ãƒœã‚¿ãƒ³ï¼ˆsystemãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ä»¥å¤–ï¼‰
  if (role !== "system") {
    const actions = document.createElement("div");
    actions.classList.add("msg-actions");

    const copyBtn = document.createElement("button");
    copyBtn.classList.add("msg-btn");
    copyBtn.textContent = "ğŸ“‹ Copy";
    copyBtn.onclick = () => {
      navigator.clipboard.writeText(div.dataset.content);
      notify("âœ… ã‚³ãƒ”ãƒ¼ã—ã¾ã—ãŸ");
    };

    const deleteBtn = document.createElement("button");
    deleteBtn.classList.add("msg-btn");
    deleteBtn.textContent = "ğŸ—‘ Delete";
    deleteBtn.onclick = () => {
      // contentã§é…åˆ—å†…ã®ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹ã‚’æ¤œç´¢
      const msgContent = div.dataset.content;
      const idx = messages.findIndex(m => m.role === role && m.content === msgContent);
      if (idx !== -1) {
        messages.splice(idx, 1);
        localStorage.setItem(STORAGE_KEY, JSON.stringify(messages));
      }
      div.remove();
      notify("âœ… ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’å‰Šé™¤ã—ã¾ã—ãŸ");
    };

    actions.appendChild(copyBtn);
    actions.appendChild(deleteBtn);

    // å†ç”Ÿæˆãƒœã‚¿ãƒ³ï¼ˆassistantãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã®ã¿ï¼‰
    if (role === "assistant") {
      const regenBtn = document.createElement("button");
      regenBtn.classList.add("msg-btn");
      regenBtn.textContent = "ğŸ”„ Regenerate";
      regenBtn.onclick = () => {
        // ã“ã®assistantãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’å‰Šé™¤
        const msgContent = div.dataset.content;
        const idx = messages.findIndex(m => m.role === "assistant" && m.content === msgContent);
        if (idx !== -1) {
          messages.splice(idx, 1);
          localStorage.setItem(STORAGE_KEY, JSON.stringify(messages));
        }
        div.remove();

        // é€ä¿¡ãƒœã‚¿ãƒ³ã‚’ã‚¯ãƒªãƒƒã‚¯ã—ã¦å†ç”Ÿæˆ
        if (messages.length > 0 && messages[messages.length - 1].role === "user") {
          sendBtn.click();
        } else {
          notify("âš ï¸ å†ç”Ÿæˆã™ã‚‹ãƒ¦ãƒ¼ã‚¶ãƒ¼ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ãŒã‚ã‚Šã¾ã›ã‚“");
        }
      };
      actions.appendChild(regenBtn);
    }

    div.appendChild(actions);
  }

  chatDiv.appendChild(div);
  chatDiv.scrollTop = chatDiv.scrollHeight;
  if (save){
    messages.push({ role, content, imageData });
    localStorage.setItem(STORAGE_KEY, JSON.stringify(messages));
  }
}
function notify(text){ appendMessage("system", text, false); }

/* === /v1/models â†’ ãƒ—ãƒ«ãƒ€ã‚¦ãƒ³è‡ªå‹•ç”Ÿæˆ === */
async function refreshModels(){
  availableModels.clear();
  const base = (settings.baseUrl || baseUrlEl.value.trim() || "").replace(/\/+$/,"");
  const key  = settings.apiKey  || apiKeyEl.value.trim();

  // ä¸€æ™‚çš„ã«ãƒ­ãƒ¼ãƒ‰ä¸­è¡¨ç¤º
  modelSel.innerHTML = "<option>Loading...</option>";
  try{
    const r = await fetch(`${base}/models`, { headers:{ "Authorization": `Bearer ${key}` } });
    if (!r.ok) throw new Error(String(r.status));
    const data = await r.json();
    const allModels = (data.data || []).map(m => m.id);
    
    // åŸ‹ã‚è¾¼ã¿ãƒ¢ãƒ‡ãƒ«ï¼ˆtext embeddingï¼‰ã‚’é™¤å¤–
    const EMBEDDING_KEYWORDS = ['embed', 'embedding', 'bge', 'e5-', 'gte-', 'jina'];
    const list = allModels.filter(id => {
      const lowerId = id.toLowerCase();
      return !EMBEDDING_KEYWORDS.some(keyword => lowerId.includes(keyword));
    });

    // æ­£å¼ã«æ§‹ç¯‰ã—ç›´ã—ï¼ˆè¡¨ç¤ºåã¯æœ«å°¾ã‚’ç°¡ç•¥ï¼‰
    modelSel.innerHTML = "";
    list.forEach(id => {
      const opt = document.createElement("option");
      opt.value = id;
      opt.textContent = id.replace(/^.*\//, "");
      modelSel.appendChild(opt);
      availableModels.add(id);
    });

    // ãƒ™ã‚¹ãƒˆãªé¸æŠè‚¢ã‚’æ±ºå®šï¼šä¿å­˜æ¸ˆã¿ â†’ Gemma â†’ LLaMA â†’ Qwen â†’ å…ˆé ­
    const preferred = settings.model;
    const fallbacks = [
      preferred,
      "google/gemma-3-12b",
      "llama-3.1-swallow-8b-instruct-v0.5",
      "qwen/qwen3-4b-2507",
      list[0]
    ].filter(Boolean);

    let chosen = null;
    for (const cand of fallbacks) {
      if (availableModels.has(cand)) { chosen = cand; break; }
    }
    if (chosen) modelSel.value = chosen;

    // èµ·å‹•æ™‚é€šçŸ¥ï¼ˆä»»æ„ï¼‰
    // notify(`âœ… ãƒ¢ãƒ‡ãƒ«ä¸€è¦§ã‚’å–å¾—: ${list.length}ä»¶`);
    saveSettings();
  }catch(e){
    modelSel.innerHTML = "";
    notify("âš ï¸ ãƒ¢ãƒ‡ãƒ«ä¸€è¦§ã‚’å–å¾—ã§ãã¾ã›ã‚“ã§ã—ãŸã€‚Base/Keyã¨ServerçŠ¶æ…‹ã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚");
  }
}
// èµ·å‹•æ™‚ã«åŒæœŸ
refreshModels();
refreshBtn.onclick = refreshModels;

/* === å¿œç­”ã‚¹ã‚¿ã‚¤ãƒ«ã®èª¬æ˜ã‚’å–å¾— === */
function getResponseStyleInstruction(){
  const style = responseStyleEl.value || "standard";
  const styleInstructions = {
    concise: "\n\nã€å¿œç­”ã‚¹ã‚¿ã‚¤ãƒ«ã€‘ç°¡æ½”ã«è¦ç‚¹ã®ã¿ã‚’è¿°ã¹ã¦ãã ã•ã„ã€‚å†—é•·ãªèª¬æ˜ã¯é¿ã‘ã€æ ¸å¿ƒçš„ãªæƒ…å ±ã®ã¿ã‚’æä¾›ã—ã¦ãã ã•ã„ã€‚",
    standard: "", // æ¨™æº–ã®å ´åˆã¯è¿½åŠ ã®æŒ‡ç¤ºãªã—
    detailed: "\n\nã€å¿œç­”ã‚¹ã‚¿ã‚¤ãƒ«ã€‘è©³ç´°ãªèª¬æ˜ã‚’å¿ƒãŒã‘ã¦ãã ã•ã„ã€‚èƒŒæ™¯æƒ…å ±ã€ç†ç”±ã€å…·ä½“ä¾‹ãªã©ã‚’å«ã‚ã¦ä¸å¯§ã«èª¬æ˜ã—ã¦ãã ã•ã„ã€‚",
    professional: "\n\nã€å¿œç­”ã‚¹ã‚¿ã‚¤ãƒ«ã€‘å°‚é–€çš„ã§æŠ€è¡“çš„ãªè©³ç´°ã‚’é‡è¦–ã—ã¦ãã ã•ã„ã€‚å­¦è¡“çš„ãªæ­£ç¢ºæ€§ã‚’ä¿ã¡ã€å°‚é–€ç”¨èªã‚’é©åˆ‡ã«ä½¿ç”¨ã—ã€ã‚¨ãƒ“ãƒ‡ãƒ³ã‚¹ã‚„æ ¹æ‹ ã‚’æ˜ç¤ºã—ã¦ãã ã•ã„ã€‚"
  };
  return styleInstructions[style] || "";
}

/* === ãƒ¦ãƒ¼ã‚¶ãƒ¼ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«æƒ…å ±ã‚’å–å¾— === */
function getUserProfileInstruction(){
  const level = userLevelEl.value;
  const profession = userProfessionEl.value.trim();
  const interests = userInterestsEl.value.trim();

  if (!level && !profession && !interests) return "";

  let profile = "\n\nã€ãƒ¦ãƒ¼ã‚¶ãƒ¼æƒ…å ±ã€‘";

  // å°‚é–€ãƒ¬ãƒ™ãƒ«ã«å¿œã˜ãŸèª¬æ˜ã‚¹ã‚¿ã‚¤ãƒ«
  const levelInstructions = {
    beginner: "ãƒ¦ãƒ¼ã‚¶ãƒ¼ã¯åˆå¿ƒè€…ã§ã™ã€‚å°‚é–€ç”¨èªã‚’é¿ã‘ã€åŸºç¤ã‹ã‚‰ä¸å¯§ã«èª¬æ˜ã—ã¦ãã ã•ã„ã€‚",
    intermediate: "ãƒ¦ãƒ¼ã‚¶ãƒ¼ã¯ä¸­ç´šè€…ã§ã™ã€‚åŸºæœ¬çš„ãªçŸ¥è­˜ã¯æŒã£ã¦ã„ã‚‹ã‚‚ã®ã¨ã—ã¦ã€é©åº¦ãªå°‚é–€ç”¨èªã‚’ä½¿ç”¨ã—ã¦èª¬æ˜ã—ã¦ãã ã•ã„ã€‚",
    advanced: "ãƒ¦ãƒ¼ã‚¶ãƒ¼ã¯ä¸Šç´šè€…ã§ã™ã€‚å°‚é–€çš„ãªå†…å®¹ã‚’æ·±ãæ˜ã‚Šä¸‹ã’ã¦èª¬æ˜ã—ã¦ãã ã•ã„ã€‚",
    expert: "ãƒ¦ãƒ¼ã‚¶ãƒ¼ã¯å°‚é–€å®¶ã§ã™ã€‚é«˜åº¦ãªå°‚é–€çŸ¥è­˜ã‚’å‰æã¨ã—ã€æœ€æ–°ã®ç ”ç©¶ã‚„è©³ç´°ãªæŠ€è¡“çš„è­°è«–ã‚’å«ã‚ã¦ãã ã•ã„ã€‚"
  };

  if (level && levelInstructions[level]) {
    profile += "\n- " + levelInstructions[level];
  }

  if (profession) {
    profile += `\n- è·æ¥­/å°‚é–€åˆ†é‡: ${profession}`;
  }

  if (interests) {
    profile += `\n- èˆˆå‘³ãƒ»é–¢å¿ƒ: ${interests}`;
  }

  return profile;
}

/* === ä¼šè©±æ•´å½¢ï¼ˆsystemå…ˆé ­ãƒ»äº¤äº’ãƒ»ç›´è¿‘12ï¼‰=== */
function buildConversation(){
  const baseSysPrompt = systemPromptEl.value || "You are a helpful Japanese-speaking assistant for a radiologist.";
  const styleInstruction = getResponseStyleInstruction();
  const profileInstruction = getUserProfileInstruction();
  const sysPrompt = baseSysPrompt + styleInstruction + profileInstruction;

  const conv = [{ role:"system", content: sysPrompt }];
  let last = "system";
  for (const m of messages){
    if (!["user","assistant"].includes(m.role)) continue;
    if (m.role === last) continue;

    // Vision APIå½¢å¼ã«å¤‰æ›
    if (m.imageData && m.role === "user") {
      const contentArray = [];
      if (m.content) {
        contentArray.push({ type: "text", text: m.content });
      }
      contentArray.push({
        type: "image_url",
        image_url: { url: m.imageData }
      });
      conv.push({ role: m.role, content: contentArray });
    } else {
      conv.push({ role: m.role, content: m.content });
    }
    last = m.role;
  }
  if (conv.length > 1 && conv.at(-1).role === "assistant") conv.pop();
  return conv.slice(-12);
}

/* === å…¥åŠ›æ¬„â€œå¼·ã„ã‚¯ãƒªã‚¢â€ï¼šæœ€å¾Œã®1æ–‡æ®‹ã‚Šå¯¾ç­– === */
function strongClearPrompt(){
  promptEl.value = "";
  promptEl.dispatchEvent(new Event("input", { bubbles:true }));
  promptEl.setSelectionRange(0, 0);
  promptEl.blur();
  setTimeout(()=>{ promptEl.value=""; },0);
  setTimeout(()=>{ promptEl.focus(); },10);
}

/* === é€ä¿¡ === */
sendBtn.onclick = async () => {
  let text = promptEl.value.trim();
  if (!text && !currentImageData && !currentFileData) return;

  // äº‹å‰ãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³ï¼šé¸æŠãƒ¢ãƒ‡ãƒ«ãŒAPIä¸Šã«å­˜åœ¨ã—ãªã„ãªã‚‰ä¸­æ­¢
  const base = (settings.baseUrl || baseUrlEl.value.trim()).replace(/\/+$/,"");
  const key  = settings.apiKey  || apiKeyEl.value.trim();
  const model= settings.model   || modelSel.value;

  if (!availableModels.size || !availableModels.has(model)){
    notify(`âš ï¸ é¸æŠãƒ¢ãƒ‡ãƒ«ãŒ /v1/models ã«è¦‹ã¤ã‹ã‚Šã¾ã›ã‚“: ${model}`);
    return;
  }

  // ç”»åƒãƒ‡ãƒ¼ã‚¿ã‚’ä¿å­˜
  const imageData = currentImageData;

  // ãƒ•ã‚¡ã‚¤ãƒ«ãŒæ·»ä»˜ã•ã‚Œã¦ã„ã‚‹å ´åˆã€ãƒ†ã‚­ã‚¹ãƒˆã«è¿½åŠ 
  let displayText = text;
  if (currentFileData) {
    const fileContent = `\n\n---\nğŸ“„ **æ·»ä»˜ãƒ•ã‚¡ã‚¤ãƒ«: ${currentFileName}**\n\`\`\`\n${currentFileData}\n\`\`\``;
    text = text ? text + fileContent : `ãƒ•ã‚¡ã‚¤ãƒ«ã€Œ${currentFileName}ã€ã®å†…å®¹:${fileContent}`;
    displayText = text ? `${promptEl.value.trim()}\n\nğŸ“ æ·»ä»˜: ${currentFileName}` : `ğŸ“ æ·»ä»˜: ${currentFileName}`;
  }

  appendMessage("user", displayText || "(ç”»åƒã®ã¿)", true, imageData);
  strongClearPrompt();

  // ç”»åƒãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ã‚’ã‚¯ãƒªã‚¢
  if (currentImageData) {
    removeImageBtn.click();
  }

  // ãƒ•ã‚¡ã‚¤ãƒ«ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ã‚’ã‚¯ãƒªã‚¢
  if (currentFileData) {
    removeFileBtn.click();
  }
  appendMessage("assistant", "...", false);

  const current = chatDiv.lastChild;

  controller = new AbortController();
  stopBtn.disabled = false;
  sendBtn.disabled = true;

  try{
    // æœ€å¾Œã®ãƒ¦ãƒ¼ã‚¶ãƒ¼ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’æ§‹ç¯‰
    let userMessage;
    if (imageData) {
      const contentArray = [];
      if (text) {
        contentArray.push({ type: "text", text });
      }
      contentArray.push({
        type: "image_url",
        image_url: { url: imageData }
      });
      userMessage = { role: "user", content: contentArray };
    } else {
      userMessage = { role: "user", content: text };
    }

    const res = await fetch(`${base}/chat/completions`, {
      method:"POST",
      headers:{
        "Content-Type":"application/json",
        "Authorization":`Bearer ${key}`
      },
      body: JSON.stringify({
        model,
        messages: [...buildConversation(), userMessage],
        stream:true,
        temperature: parseFloat(temperatureEl.value) || 0.7,
        max_tokens: parseInt(maxTokensEl.value) || 2048
      }),
      signal: controller.signal
    });

    if (!res.ok || !res.body){
      const t = await res.text().catch(()=> "");
      const contentEl = current.querySelector(".message-content");
      if (contentEl) contentEl.textContent = `ã‚¨ãƒ©ãƒ¼:${res.status}${t ? " / "+t : ""}`;
      return;
    }

    const reader  = res.body.getReader();
    const decoder = new TextDecoder("utf-8");
    let buf = "", content = "";

    while (true){
      const { value, done } = await reader.read();
      if (done) break;

      buf += decoder.decode(value, { stream:true });
      const events = buf.split("\n\n");
      buf = events.pop() || "";

      for (const ev of events){
        const lines = ev.split("\n").filter(l=>l.startsWith("data: ")).map(l=>l.slice(6));
        if (!lines.length) continue;

        const payload = lines.join("\n");
        if (payload === "[DONE]"){
          const contentEl = current.querySelector(".message-content");
          if (contentEl) contentEl.innerHTML = marked.parse(content || "(ç©ºå¿œç­”)");
          current.dataset.content = content;  // ã‚³ãƒ”ãƒ¼æ©Ÿèƒ½ç”¨ã«ãƒ‡ãƒ¼ã‚¿ã‚’æ›´æ–°
          messages.push({ role:"assistant", content });
          localStorage.setItem(STORAGE_KEY, JSON.stringify(messages));
          stopBtn.disabled = true;
          controller = null;
          return;
        }
        try{
          const j = JSON.parse(payload);
          const delta = j.choices?.[0]?.delta?.content ?? j.choices?.[0]?.text ?? "";
          if (delta){
            content += delta;
            const contentEl = current.querySelector(".message-content");
            if (contentEl) contentEl.innerHTML = marked.parse(content);
            chatDiv.scrollTop = chatDiv.scrollHeight;
          }
        }catch{/* ä¸å®Œå…¨JSONã¯æ¬¡ãƒãƒ£ãƒ³ã‚¯ã§å®Œæˆ */}
      }
    }
  }catch(e){
    const contentEl = current.querySelector(".message-content");
    if (e.name === "AbortError"){
      if (contentEl) contentEl.innerHTML = marked.parse("â¹ **ç”Ÿæˆã‚’åœæ­¢ã—ã¾ã—ãŸã€‚**");
    }else{
      if (contentEl) contentEl.textContent = `é€šä¿¡ã‚¨ãƒ©ãƒ¼: ${e}`;
    }
  }finally{
    stopBtn.disabled = true;
    sendBtn.disabled = false;
    controller = null;
  }
};

/* === Stop === */
stopBtn.onclick = () => { if (controller) controller.abort(); };

/* === Enteré€ä¿¡ï¼šIMEå¤‰æ›ä¸­ã¯é€ä¿¡ã—ãªã„ === */
promptEl.addEventListener("keydown", e => {
  if (e.isComposing || e.keyCode === 229) return; // æ—¥æœ¬èªIMEå¤‰æ›ä¸­ã¯ç„¡è¦–
  if (e.key === "Enter" && !e.shiftKey){
    e.preventDefault();
    sendBtn.click();
  }
});

/* === ãƒ¢ãƒ‡ãƒ«é¸æŠæ™‚ï¼šä¿å­˜ï¼†é€šçŸ¥ === */
modelSel.addEventListener("change", e => {
  saveSettings();
  const id = e.target.value;
  notify(`ğŸ”„ ãƒ¢ãƒ‡ãƒ«ã‚’ ${id} ã«åˆ‡ã‚Šæ›¿ãˆã¾ã—ãŸ`);
});

/* === Export / Clear === */
document.getElementById("exportBtn").onclick = () => {
  const blob = new Blob([JSON.stringify(messages,null,2)], { type:"application/json" });
  const url  = URL.createObjectURL(blob);
  const a    = document.createElement("a");
  a.href = url;
  a.download = `chat_history_${new Date().toISOString().slice(0,19)}.json`;
  a.click();
  URL.revokeObjectURL(url);
};

document.getElementById("clearBtn").onclick = () => {
  if (!confirm("å±¥æ­´ã‚’ã™ã¹ã¦å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ")) return;
  localStorage.removeItem(STORAGE_KEY);
  messages = [];
  chatDiv.innerHTML = "";
  notify("ğŸ—‘ ä¼šè©±å±¥æ­´ã‚’å‰Šé™¤ã—ã¾ã—ãŸã€‚");
};

/* === è¨­å®šãƒ‘ãƒãƒ«ã®ãƒˆã‚°ãƒ« === */
settingsBtn.onclick = () => {
  settingsPanel.classList.toggle("open");
};

// è¨­å®šãƒ‘ãƒãƒ«ã®ã€Œæˆ»ã‚‹ã€ãƒœã‚¿ãƒ³
document.getElementById("closeSettingsBtn").onclick = () => {
  settingsPanel.classList.remove("open");
};

/* === å…¥åŠ›æ¬„ã®è‡ªå‹•æ‹¡å¼µ === */
promptEl.addEventListener("input", () => {
  promptEl.style.height = "56px";
  const newHeight = Math.min(promptEl.scrollHeight, 240);
  promptEl.style.height = newHeight + "px";
});

/* === ã‚­ãƒ¼ãƒœãƒ¼ãƒ‰ã‚·ãƒ§ãƒ¼ãƒˆã‚«ãƒƒãƒˆ === */
document.addEventListener("keydown", e => {
  // Ctrl+K ã¾ãŸã¯ Cmd+K ã§ã‚¯ãƒªã‚¢
  if ((e.ctrlKey || e.metaKey) && e.key === "k") {
    e.preventDefault();
    document.getElementById("clearBtn").click();
  }
  // Esc ã§è¨­å®šãƒ‘ãƒãƒ«ã‚’é–‰ã˜ã‚‹
  if (e.key === "Escape" && settingsPanel.classList.contains("open")) {
    settingsPanel.classList.remove("open");
  }
});

/* === ç”»åƒé¸æŠã¨ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ === */
imageInputEl.addEventListener("change", (e) => {
  const file = e.target.files[0];
  if (!file) return;

  // ãƒ•ã‚¡ã‚¤ãƒ«ã‚¿ã‚¤ãƒ—ãƒã‚§ãƒƒã‚¯
  if (!file.type.startsWith("image/")) {
    notify("âš ï¸ ç”»åƒãƒ•ã‚¡ã‚¤ãƒ«ã‚’é¸æŠã—ã¦ãã ã•ã„");
    imageInputEl.value = "";
    return;
  }

  // ãƒ•ã‚¡ã‚¤ãƒ«ã‚µã‚¤ã‚ºãƒã‚§ãƒƒã‚¯ï¼ˆ20MBä»¥ä¸‹ï¼‰
  if (file.size > 20 * 1024 * 1024) {
    notify("âš ï¸ ç”»åƒã‚µã‚¤ã‚ºã¯20MBä»¥ä¸‹ã«ã—ã¦ãã ã•ã„");
    imageInputEl.value = "";
    return;
  }

  // ç”»åƒã‚’base64ã‚¨ãƒ³ã‚³ãƒ¼ãƒ‰
  const reader = new FileReader();
  reader.onload = (event) => {
    currentImageData = event.target.result;
    previewImgEl.src = currentImageData;
    previewImgEl.style.display = "block";
    imagePreviewEl.style.display = "block";
    notify("âœ… ç”»åƒã‚’æ·»ä»˜ã—ã¾ã—ãŸ");
  };
  reader.onerror = () => {
    notify("âš ï¸ ç”»åƒã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸ");
    imageInputEl.value = "";
  };
  reader.readAsDataURL(file);
});

// ç”»åƒå‰Šé™¤
removeImageBtn.onclick = () => {
  currentImageData = null;
  previewImgEl.src = "";
  previewImgEl.style.display = "none";
  imagePreviewEl.style.display = "none";
  imageInputEl.value = "";
};

/* === ãƒ•ã‚¡ã‚¤ãƒ«é¸æŠã¨ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ === */
fileInputEl.addEventListener("change", async (e) => {
  const file = e.target.files[0];
  if (!file) return;

  // ãƒ•ã‚¡ã‚¤ãƒ«ã‚µã‚¤ã‚ºãƒã‚§ãƒƒã‚¯ï¼ˆ1MBä»¥ä¸‹ï¼‰
  if (file.size > 1 * 1024 * 1024) {
    notify("âš ï¸ ãƒ•ã‚¡ã‚¤ãƒ«ã‚µã‚¤ã‚ºã¯1MBä»¥ä¸‹ã«ã—ã¦ãã ã•ã„");
    return;
  }

  // ãƒ†ã‚­ã‚¹ãƒˆãƒ•ã‚¡ã‚¤ãƒ«ã¨ã—ã¦èª­ã¿è¾¼ã¿
  const reader = new FileReader();
  reader.onload = (event) => {
    currentFileData = event.target.result;
    currentFileName = file.name;
    fileNameEl.textContent = `ğŸ“„ ${file.name}`;
    filePreviewEl.style.display = "block";
    notify(`âœ… ãƒ•ã‚¡ã‚¤ãƒ«ã€Œ${file.name}ã€ã‚’æ·»ä»˜ã—ã¾ã—ãŸ`);
  };
  reader.onerror = () => {
    notify("âš ï¸ ãƒ•ã‚¡ã‚¤ãƒ«ã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸ");
  };
  reader.readAsText(file);
});

// ãƒ•ã‚¡ã‚¤ãƒ«å‰Šé™¤
removeFileBtn.onclick = () => {
  currentFileData = null;
  currentFileName = null;
  fileNameEl.textContent = "";
  filePreviewEl.style.display = "none";
  fileInputEl.value = "";
};

/* === ãƒ€ãƒ¼ã‚¯ãƒ¢ãƒ¼ãƒ‰åˆ‡ã‚Šæ›¿ãˆ === */
darkModeToggle.onchange = () => {
  if (darkModeToggle.checked) {
    document.body.classList.add("dark-mode");
  } else {
    document.body.classList.remove("dark-mode");
  }
  saveSettings();
};

/* === ç”»åƒã®ãƒšãƒ¼ã‚¹ãƒˆå¯¾å¿œ === */
document.addEventListener("paste", (e) => {
  const items = e.clipboardData?.items;
  if (!items) return;

  for (const item of items) {
    // ç”»åƒã‚¢ã‚¤ãƒ†ãƒ ã‚’æ¢ã™
    if (item.type.startsWith("image/")) {
      e.preventDefault();

      const file = item.getAsFile();
      if (!file) continue;

      // ãƒ•ã‚¡ã‚¤ãƒ«ã‚µã‚¤ã‚ºãƒã‚§ãƒƒã‚¯ï¼ˆ20MBä»¥ä¸‹ï¼‰
      if (file.size > 20 * 1024 * 1024) {
        notify("âš ï¸ ç”»åƒã‚µã‚¤ã‚ºã¯20MBä»¥ä¸‹ã«ã—ã¦ãã ã•ã„");
        return;
      }

      // ç”»åƒã‚’base64ã‚¨ãƒ³ã‚³ãƒ¼ãƒ‰
      const reader = new FileReader();
      reader.onload = (event) => {
        currentImageData = event.target.result;
        previewImgEl.src = currentImageData;
        previewImgEl.style.display = "block";
        imagePreviewEl.style.display = "block";
        notify("âœ… ç”»åƒãŒãƒšãƒ¼ã‚¹ãƒˆã•ã‚Œã¾ã—ãŸ");
      };
      reader.readAsDataURL(file);
      break;
    }
  }
});

/* === ç”»åƒã®ãƒ‰ãƒ©ãƒƒã‚°ï¼†ãƒ‰ãƒ­ãƒƒãƒ—å¯¾å¿œ === */
// ãƒ‰ãƒ©ãƒƒã‚°ã‚ªãƒ¼ãƒãƒ¼æ™‚ã®ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆå‹•ä½œã‚’é˜²æ­¢
document.addEventListener("dragover", (e) => {
  e.preventDefault();
  e.stopPropagation();
});

document.addEventListener("dragenter", (e) => {
  e.preventDefault();
  e.stopPropagation();
  document.body.style.opacity = "0.7";
});

document.addEventListener("dragleave", (e) => {
  e.preventDefault();
  e.stopPropagation();
  // ç”»é¢å¤–ã«å‡ºãŸæ™‚ã®ã¿ opacity ã‚’ãƒªã‚»ãƒƒãƒˆ
  if (e.relatedTarget === null) {
    document.body.style.opacity = "1";
  }
});

document.addEventListener("drop", (e) => {
  e.preventDefault();
  e.stopPropagation();
  document.body.style.opacity = "1";

  const files = e.dataTransfer?.files;
  if (!files || files.length === 0) return;

  const file = files[0];

  // ç”»åƒãƒ•ã‚¡ã‚¤ãƒ«ã‹ãƒã‚§ãƒƒã‚¯
  if (!file.type.startsWith("image/")) {
    notify("âš ï¸ ç”»åƒãƒ•ã‚¡ã‚¤ãƒ«ã‚’ãƒ‰ãƒ­ãƒƒãƒ—ã—ã¦ãã ã•ã„");
    return;
  }

  // ãƒ•ã‚¡ã‚¤ãƒ«ã‚µã‚¤ã‚ºãƒã‚§ãƒƒã‚¯ï¼ˆ20MBä»¥ä¸‹ï¼‰
  if (file.size > 20 * 1024 * 1024) {
    notify("âš ï¸ ç”»åƒã‚µã‚¤ã‚ºã¯20MBä»¥ä¸‹ã«ã—ã¦ãã ã•ã„");
    return;
  }

  // ç”»åƒã‚’base64ã‚¨ãƒ³ã‚³ãƒ¼ãƒ‰
  const reader = new FileReader();
  reader.onload = (event) => {
    currentImageData = event.target.result;
    previewImgEl.src = currentImageData;
    previewImgEl.style.display = "block";
    imagePreviewEl.style.display = "block";
    notify("âœ… ç”»åƒã‚’ãƒ‰ãƒ­ãƒƒãƒ—ã—ã¾ã—ãŸ");
  };
  reader.onerror = () => {
    notify("âš ï¸ ç”»åƒã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸ");
  };
  reader.readAsDataURL(file);
});
</script>
</body>
</html>